<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ProBoost - Admin Dashboard</title>
  <link rel="stylesheet" href="admin.css" />
</head>
<body>
  <!-- Navbar -->
  <header class="navbar">
    <div class="logo">
      <img src="Logo.png" alt="ProBoost Logo" />
      <span>ProBoost Admin</span>
    </div>
    <nav class="nav-links">
      <a href="#" class="active" onclick="showSection('home', this)">🏠 Home</a>
      <a href="#" onclick="showSection('manage-users', this)">👤 Manage Users</a>
      <a href="#" onclick="showSection('manage-workspaces', this)">💼 Manage Workspaces</a>
      <a href="#" onclick="showSection('system-settings', this)">⚙️ System Settings</a>
      <a href="#" onclick="showSection('view-reports', this)">📊 View Reports</a>
      <a href="#" class="logout-btn" onclick="logout()">🚪 Logout</a>
    </nav>
  </header>

  <script>
  // Block access if not logged in as admin
  if (localStorage.getItem("isAdmin") !== "true") {
    alert("❌ Access Denied!");
    window.location.href = "Login page.html";
  }
</script>

  <!-- Main Content -->
  <main class="main-container">
    <!-- Home -->
    <section id="home" class="section active">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
          <h1>Welcome to ProBoost Admin Dashboard</h1>
          <p class="subtitle">Quick overview of your system</p>
        </div>
        <div style="text-align: right;">
          <p style="color: #666; font-size: 0.9rem;">Logged in as:</p>
          <p style="font-weight: bold; color: #1565c0;" id="adminEmailDisplay">Loading...</p>
        </div>
      </div>

      <div class="cards">
        <div class="card">
          <h3>👤 Users</h3>
          <p id="userCount">0 Active Users</p>
        </div>
        <div class="card">
          <h3>💼 Workspaces</h3>
          <p id="workspaceCount">0 Workspaces</p>
        </div>
        <div class="card">
          <h3>⚙️ Settings</h3>
          <p>System Optimized</p>
        </div>
        <div class="card">
          <h3>📊 Reports</h3>
          <p>12 New Reports</p>
        </div>
      </div>
    </section>

    <!-- Manage Users -->
    <section id="manage-users" class="section">
      <h2>👤 Manage Users</h2>
      <div class="actions">
        <button onclick="openUserForm('add')">➕ Add User</button>
        <button onclick="openUserForm('edit')">✏️ Edit User</button>
        <button onclick="removeUser()">🗑 Remove User</button>
        <button onclick="refreshUserTable()">🔄 Refresh</button>
      </div>

      <!-- Admin-managed users table (role/status) -->
      <table id="userTable">
        <thead>
          <tr>
            <th>Select</th>
            <th>User ID</th>
            <th>Email</th>
            <th>Role</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <!-- Users will be populated from localStorage userTable -->
        </tbody>
      </table>
      
      <!-- User Form Modal -->
      <div id="userFormModal" class="modal" style="display:none;">
        <div class="modal-content">
          <span class="close" onclick="closeUserForm()">&times;</span>
          <h3 id="formTitle">Add User</h3>
          <form id="userForm" onsubmit="saveUser(event)">
            <label>User ID</label>
            <input type="text" id="userId" required />

            <label>Email</label>
            <input type="email" id="userEmail" required />

            <label>Role</label>
            <select id="userRole">
              <option value="User">User</option>
              <option value="Admin">Admin</option>
            </select>

            <label>Status</label>
            <select id="userStatus">
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>

            <button type="submit">💾 Save</button>
          </form>
        </div>
      </div>
    </section>

    <!-- Manage Workspaces -->
    <section id="manage-workspaces" class="section">
      <h2>💼 Manage Workspaces</h2>
      <div class="actions">
        <button onclick="openWorkspaceForm('create')">➕ Create Workspace</button>
        <button onclick="viewWorkspaces()">📂 View Workspaces</button>
        <button onclick="openDeleteWorkspace()">🗑 Delete Workspace</button>
      </div>

      <!-- Create Workspace Form -->
      <div id="createWorkspaceForm" style="display:none;">
        <h3>Create New Workspace</h3>
        <form onsubmit="createWorkspace(event)">
          <label>Workspace Name</label>
          <input type="text" id="workspaceName" required />

          <label>Description</label>
          <textarea id="workspaceDesc" rows="3"></textarea>

          <label>Type</label>
          <select id="workspaceType">
            <option value="Team">Team</option>
            <option value="Private">Private</option>
            <option value="Public">Public</option>
          </select>

          <div style="margin-top: 15px;">
            <button type="submit">💾 Create Workspace</button>
            <button type="button" onclick="cancelWorkspaceForm()">❌ Cancel</button>
          </div>
        </form>
      </div>

      <!-- View Workspaces -->
      <div id="workspaceView" style="display:none;">
        <h3>All Workspaces</h3>
        <table id="workspaceTable">
          <thead>
            <tr>
              <th>Select</th>
              <th>Workspace ID</th>
              <th>Name</th>
              <th>Description</th>
              <th>Type</th>
              <th>Members</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button onclick="hideWorkspaceView()">❌ Close</button>
      </div>

      <!-- Delete Workspace Form -->
      <div id="deleteWorkspaceForm" style="display:none;">
        <h3>Delete Workspace</h3>
        <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <p style="color: #c62828; margin: 0;">⚠️ Warning: This action cannot be undone!</p>
        </div>
        <div>
          <label>Select Workspace to Delete</label>
          <select id="deleteWorkspaceSelect" required>
            <option value="">Choose a workspace...</option>
          </select>

          <div style="margin-top: 15px;">
            <button onclick="deleteSelectedWorkspace()" style="background: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">🗑 DELETE</button>
            <button onclick="cancelDeleteWorkspace()" style="background: #666; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">❌ Cancel</button>
          </div>
        </div>
      </div>
    </section>

    <!-- System Settings -->
    <section id="system-settings" class="section">
      <h2>⚙️ System Settings</h2>
      <div class="settings-list">
        <div class="setting-item">
          <span>🔧 Update System</span>
          <button>Update</button>
        </div>
        <div class="setting-item">
          <span>🔒 Set Permissions</span>
          <button>Manage</button>
        </div>
        <div class="setting-item">
          <span>🚪 Logout</span>
          <button onclick="logout()" style="background: #f44336; color: white;">Logout</button>
        </div>
      </div>
    </section>

    <!-- View Reports -->
    <section id="view-reports" class="section">
      <h2>📊 View Reports</h2>
      <div class="cards">
        <div class="card">
          <h3>📈 Analytics</h3>
          <p>Track user and workspace growth trends.</p>
        </div>
        <div class="card">
          <h3>📜 Logs</h3>
          <p>View system activities and logs for security monitoring.</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Logout Confirmation Modal -->
  <div id="logoutModal" class="modal" style="display:none;">
    <div class="modal-content" style="text-align: center; max-width: 400px;">
      <h3>🚪 Confirm Logout</h3>
      <p style="margin: 20px 0; color: #666;">Are you sure you want to logout?</p>
      <div style="display: flex; gap: 15px; justify-content: center;">
        <button onclick="confirmLogout()" style="background: #f44336;">Yes, Logout</button>
        <button onclick="cancelLogout()" style="background: #666;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Quick Access Panel for Testing -->
  <div id="quickAccess" style="position: fixed; bottom: 20px; right: 20px; background: rgba(33, 150, 243, 0.9); color: white; padding: 15px; border-radius: 10px; font-size: 12px; max-width: 250px;">
    <div style="margin-bottom: 10px; font-weight: bold;">🔧 Quick Admin Access</div>
    <div style="margin-bottom: 5px;">
      <button onclick="enableAdminAccess()" style="padding: 5px 10px; font-size: 11px;">Enable Admin Access</button>
    </div>
    <div style="font-size: 10px; opacity: 0.8;">Click to set admin credentials</div>
  </div>

  <script>
    // -------- AUTH GUARD (FIXED) --------
    document.addEventListener('DOMContentLoaded', () => {
      checkAuthentication();
      displayAdminInfo();
      refreshUserTable();
      updateUserCount();
      updateWorkspaceCount();
    });

    function checkAuthentication() {
      // Enhanced authentication check with multiple fallbacks
      const isAdmin = localStorage.getItem('isAdmin') === 'true';
      const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
      const userType = localStorage.getItem('userType');
      const userRole = localStorage.getItem('userRole');
      const currentUser = localStorage.getItem('currentUser');
      
      // Check multiple possible admin indicators
      const adminIndicators = [
        isAdmin,
        (isLoggedIn && userType === 'admin'),
        (userRole === 'admin'),
        (currentUser === 'admin'),
        (localStorage.getItem('adminLoggedIn') === 'true')
      ];
      
      const allowed = adminIndicators.some(indicator => indicator === true);

      if (!allowed) {
        // Show a more helpful message
        const hasAnyAuth = localStorage.getItem('isLoggedIn') || localStorage.getItem('userEmail') || localStorage.getItem('currentUser');
        
        if (hasAnyAuth) {
          alert('Access denied. You need admin privileges to access this dashboard.');
        } else {
          alert('Access denied. Please login as admin first.');
        }
        
        // Redirect to login page
        window.location.href = 'Login page.html';
        return;
      }

      console.log('✅ Admin access granted');
    }

    function enableAdminAccess() {
      // Quick function to enable admin access for testing
      localStorage.setItem('isAdmin', 'true');
      localStorage.setItem('isLoggedIn', 'true');
      localStorage.setItem('userType', 'admin');
      localStorage.setItem('userEmail', 'sha123@gmail.com');
      localStorage.setItem('adminLoggedIn', 'true');
      
      alert('✅ Admin access enabled! Refreshing page...');
      location.reload();
    }

    function displayAdminInfo() {
      // Show saved email or fallback to fixed admin email
      const savedEmail = localStorage.getItem('userEmail') || 
                        localStorage.getItem('adminEmail') || 
                        localStorage.getItem('currentUserEmail') ||
                        'sha123@gmail.com';
      
      document.getElementById('adminEmailDisplay').textContent = savedEmail;
    }

    // -------- NAV --------
    function showSection(sectionId, link) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      const target = document.getElementById(sectionId);
      if (target) target.classList.add('active');

      document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
      if (link) link.classList.add('active');
    }

    // -------- LOGOUT --------
    function logout() {
      document.getElementById('logoutModal').style.display = 'block';
    }

    function confirmLogout() {
      // Clear all possible session markers
      const keysToRemove = [
        'isAdmin', 'isLoggedIn', 'userType', 'userEmail', 'loginTime',
        'adminLoggedIn', 'userRole', 'currentUser', 'currentUserEmail',
        'adminEmail', 'sessionToken', 'authToken'
      ];
      
      keysToRemove.forEach(key => localStorage.removeItem(key));

      alert('✅ Successfully logged out!');
      window.location.href = 'Landing Page.html';
    }

    function cancelLogout() {
      document.getElementById('logoutModal').style.display = 'none';
    }

    // -------- MANAGE USERS (Dynamic from localStorage) --------
    let currentAction = 'add';

    function refreshUserTable() {
      const tbody = document.querySelector('#userTable tbody');
      tbody.innerHTML = '';

      // Get users from localStorage userTable (created by signup page)
      const users = JSON.parse(localStorage.getItem('userTable') || '[]');

      if (users.length === 0) {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td colspan="5" style="text-align: center; color: #888; font-style: italic;">
            No users registered yet. Users will appear here when they sign up.
          </td>
        `;
        return;
      }

      users.forEach(user => {
        const row = tbody.insertRow();
        const isAdmin = user.role === 'Admin';
        
        row.innerHTML = `
          <td><input type="radio" name="selectedUser" value="${user.id}" ${isAdmin ? 'disabled' : ''}></td>
          <td>${user.id}</td>
          <td>${user.email}</td>
          <td>${user.role}</td>
          <td>${user.status}</td>
        `;
      });
    }

    function openUserForm(action) {
      currentAction = action;
      const modal = document.getElementById('userFormModal');
      const formTitle = document.getElementById('formTitle');
      const userId = document.getElementById('userId');
      const userEmail = document.getElementById('userEmail');
      const userRole = document.getElementById('userRole');
      const userStatus = document.getElementById('userStatus');

      if (action === 'add') {
        formTitle.textContent = 'Add User';
        userId.value = '';
        userEmail.value = '';
        userRole.value = 'User';
        userStatus.value = 'Active';
      } else if (action === 'edit') {
        formTitle.textContent = 'Edit User';
        const selected = document.querySelector("input[name='selectedUser']:checked");
        if (!selected) {
          alert('Please select a user to edit (Admin cannot be edited).');
          return;
        }
        const row = selected.closest('tr');
        userId.value = row.cells[1].textContent;
        userEmail.value = row.cells[2].textContent;
        userRole.value = row.cells[3].textContent;
        userStatus.value = row.cells[4].textContent;
      }
      modal.style.display = 'block';
    }

    function closeUserForm() {
      document.getElementById('userFormModal').style.display = 'none';
    }

    function saveUser(event) {
      event.preventDefault();
      const userId = document.getElementById('userId').value.trim();
      const userEmail = document.getElementById('userEmail').value.trim();
      const userRole = document.getElementById('userRole').value;
      const userStatus = document.getElementById('userStatus').value;

      if (!userId || !userEmail) {
        alert('User ID and Email are required.');
        return;
      }

      let users = JSON.parse(localStorage.getItem('userTable') || '[]');

      if (currentAction === 'add') {
        // Check if email already exists
        if (users.some(u => u.email === userEmail)) {
          alert('Email already exists!');
          return;
        }

        // Generate new user ID if not provided
        let newUserId = userId;
        if (!newUserId || newUserId === '') {
          newUserId = "U" + String(users.length + 1).padStart(3, "0");
          document.getElementById('userId').value = newUserId;
        }

        const newUser = {
          id: newUserId,
          email: userEmail,
          password: 'TempPass123!', // Default password - user should change
          role: userRole,
          status: userStatus
        };

        users.push(newUser);
        
      } else if (currentAction === 'edit') {
        const userIndex = users.findIndex(u => u.id === userId);
        if (userIndex > -1) {
          users[userIndex].email = userEmail;
          users[userIndex].role = userRole;
          users[userIndex].status = userStatus;
        }
      }

      localStorage.setItem('userTable', JSON.stringify(users));
      refreshUserTable();
      closeUserForm();
      updateUserCount();
      alert('✅ User saved successfully!');
    }

    function removeUser() {
      const selected = document.querySelector("input[name='selectedUser']:checked");
      if (!selected) {
        alert('Please select a user to remove (Admin cannot be removed).');
        return;
      }
      
      if (confirm('Are you sure you want to remove this user?')) {
        const userId = selected.value;
        let users = JSON.parse(localStorage.getItem('userTable') || '[]');
        
        users = users.filter(u => u.id !== userId);
        localStorage.setItem('userTable', JSON.stringify(users));
        
        refreshUserTable();
        updateUserCount();
        alert('✅ User removed successfully!');
      }
    }

    function updateUserCount() {
      const users = JSON.parse(localStorage.getItem('userTable') || '[]');
      const activeUsers = users.filter(u => u.status === 'Active').length;
      document.getElementById('userCount').textContent = `${activeUsers} Active Users`;
    }

    // -------- WORKSPACE MANAGEMENT (UPDATED) --------
    let workspaces = JSON.parse(localStorage.getItem('workspaces') || '[]');
    let workspaceCounter = workspaces.length + 1;

    function openWorkspaceForm() {
      hideAllWorkspaceForms();
      document.getElementById('createWorkspaceForm').style.display = 'block';
      document.getElementById('workspaceName').value = '';
      document.getElementById('workspaceDesc').value = '';
      document.getElementById('workspaceType').value = 'Team';
    }

    function createWorkspace(event) {
      event.preventDefault();
      const name = document.getElementById('workspaceName').value.trim();
      const desc = document.getElementById('workspaceDesc').value.trim();
      const type = document.getElementById('workspaceType').value;

      if (!name) {
        alert('Workspace name is required.');
        return;
      }

      const newWorkspace = {
        id: `W${String(workspaceCounter).padStart(3, '0')}`,
        name,
        description: desc || 'No description',
        type,
        members: 0
      };

      workspaces.push(newWorkspace);
      workspaceCounter++;

      // Save to localStorage
      localStorage.setItem('workspaces', JSON.stringify(workspaces));

      alert(`✅ Workspace "${name}" created successfully!`);
      cancelWorkspaceForm();
      updateWorkspaceCount();
    }

    function viewWorkspaces() {
      hideAllWorkspaceForms();
      document.getElementById('workspaceView').style.display = 'block';

      const tbody = document.querySelector('#workspaceTable tbody');
      tbody.innerHTML = '';

      if (workspaces.length === 0) {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td colspan="6" style="text-align: center; color: #888; font-style: italic;">
            No workspaces created yet. Create your first workspace!
          </td>
        `;
        return;
      }

      workspaces.forEach(ws => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td><input type="radio" name="selectedWorkspace" value="${ws.id}"></td>
          <td>${ws.id}</td>
          <td>${ws.name}</td>
          <td>${ws.description}</td>
          <td>${ws.type}</td>
          <td>${ws.members}</td>
        `;
      });
    }

    function hideWorkspaceView() {
      document.getElementById('workspaceView').style.display = 'none';
    }

    function openDeleteWorkspace() {
      hideAllWorkspaceForms();
      document.getElementById('deleteWorkspaceForm').style.display = 'block';

      const select = document.getElementById('deleteWorkspaceSelect');
      select.innerHTML = '<option value="">Choose a workspace...</option>';
      
      if (workspaces.length === 0) {
        select.innerHTML = '<option value="">No workspaces to delete</option>';
        return;
      }
      
      workspaces.forEach(ws => {
        select.innerHTML += `<option value="${ws.id}">${ws.name}</option>`;
      });
    }

    function deleteSelectedWorkspace() {
      const workspaceId = document.getElementById('deleteWorkspaceSelect').value;

      if (!workspaceId) {
        alert('Please choose a workspace to delete.');
        return;
      }

      const workspaceToDelete = workspaces.find(ws => ws.id === workspaceId);
      if (!workspaceToDelete) {
        alert('Workspace not found.');
        return;
      }

      if (confirm(`Are you sure you want to delete "${workspaceToDelete.name}"? This action cannot be undone.`)) {
        // Remove workspace from array
        workspaces = workspaces.filter(ws => ws.id !== workspaceId);
        
        // Update localStorage
        localStorage.setItem('workspaces', JSON.stringify(workspaces));
        
        alert(`✅ Workspace "${workspaceToDelete.name}" has been deleted.`);
        cancelDeleteWorkspace();
        updateWorkspaceCount();
      }
    }

    function cancelWorkspaceForm() {
      hideAllWorkspaceForms();
    }

    function cancelDeleteWorkspace() {
      hideAllWorkspaceForms();
    }

    function hideAllWorkspaceForms() {
      document.getElementById('createWorkspaceForm').style.display = 'none';
      document.getElementById('workspaceView').style.display = 'none';
      document.getElementById('deleteWorkspaceForm').style.display = 'none';
    }

    function updateWorkspaceCount() {
      document.getElementById('workspaceCount').textContent = `${workspaces.length} Workspaces`;
    }

    // -------- MODAL OUTSIDE CLICK CLOSE --------
    window.onclick = function (event) {
      const userModal = document.getElementById('userFormModal');
      const logoutModal = document.getElementById('logoutModal');

      if (event.target === userModal) closeUserForm();
      if (event.target === logoutModal) cancelLogout();
    };

    // -------- HIDE QUICK ACCESS AFTER USE --------
    setTimeout(() => {
      const quickAccess = document.getElementById('quickAccess');
      if (quickAccess && localStorage.getItem('isAdmin') === 'true') {
        quickAccess.style.display = 'none';
      }
    }, 10000); // Hide after 10 seconds if already authenticated
  </script>
</body>
</html>