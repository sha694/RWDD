<?php
session_start();
if (!isset($_SESSION['email']) || $_SESSION['role'] !== 'admin') {
    header("Location: login.php");
    exit();
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ProBoost - Admin Dashboard</title>
  <link rel="stylesheet" href="admin.css" />
</head>
<body>
  <!-- Navbar -->
  <header class="navbar">
    <div class="logo">
      <img src="Logo.png" alt="ProBoost Logo" />
      <span>ProBoost Admin</span>
    </div>
    <nav class="nav-links">
      <a href="#" class="active" onclick="showSection('home', this)">üè† Home</a>
      <a href="#" onclick="showSection('manage-users', this)">üë§ Manage Users</a>
      <a href="#" onclick="showSection('manage-workspaces', this)">üíº Manage Workspaces</a>
      <a href="#" onclick="showSection('system-settings', this)">‚öôÔ∏è System Settings</a>
      <a href="#" onclick="showSection('view-reports', this)">üìä View Reports</a>
      <a href="#" class="logout-btn" onclick="logout()">üö™ Logout</a>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="main-container">
    <!-- Home -->
    <section id="home" class="section active">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
          <h1>Welcome to ProBoost Admin Dashboard</h1>
          <p class="subtitle">Quick overview of your system</p>
        </div>
        <div style="text-align: right;">
          <p style="color: #666; font-size: 0.9rem;">Logged in as:</p>
          <p style="font-weight: bold; color: #1565c0;" id="adminEmailDisplay">Loading...</p>
        </div>
      </div>

      <div class="cards">
        <div class="card">
          <h3>üë§ Users</h3>
          <p id="userCount">0 Active Users</p>
        </div>
        <div class="card">
          <h3>üíº Workspaces</h3>
          <p id="workspaceCount">0 Workspaces</p>
        </div>
        <div class="card">
          <h3>‚öôÔ∏è Settings</h3>
          <p>System Optimized</p>
        </div>
        <div class="card">
          <h3>üìä Reports</h3>
          <p>12 New Reports</p>
        </div>
      </div>
    </section>

    <!-- Manage Users -->
    <section id="manage-users" class="section">
      <h2>üë§ Manage Users</h2>
      <div class="actions">
        <button onclick="openUserForm('add')">‚ûï Add User</button>
        <button onclick="openUserForm('edit')">‚úèÔ∏è Edit User</button>
        <button onclick="removeUser()">üóë Remove User</button>
        <button onclick="refreshUserTable()">üîÑ Refresh</button>
      </div>

      <!-- Admin-managed users table -->
      <table id="userTable">
        <thead>
          <tr>
            <th>Select</th>
            <th>User ID</th>
            <th>Email</th>
            <th>Role</th>
            <th>Status</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody>
          <!-- Users will be populated from localStorage users -->
        </tbody>
      </table>
      
      <!-- User Form Modal -->
      <div id="userFormModal" class="modal" style="display:none;">
        <div class="modal-content">
          <span class="close" onclick="closeUserForm()">&times;</span>
          <h3 id="formTitle">Add User</h3>
          <form id="userForm" onsubmit="saveUser(event)">
            <label>Email</label>
            <input type="email" id="userEmail" required />

            <label>Password</label>
            <input type="password" id="userPassword" required />

            <label>Role</label>
            <select id="userRole">
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select>

            <button type="submit">üíæ Save</button>
          </form>
        </div>
      </div>
    </section>

    <!-- Manage Workspaces -->
    <section id="manage-workspaces" class="section">
      <h2>üíº Manage Workspaces</h2>
      <div class="actions">
        <button onclick="openWorkspaceForm('create')">‚ûï Create Workspace</button>
        <button onclick="viewWorkspaces()">üìÇ View Workspaces</button>
        <button onclick="openDeleteWorkspace()">üóë Delete Workspace</button>
      </div>

      <!-- Create Workspace Form -->
      <div id="createWorkspaceForm" style="display:none;">
        <h3>Create New Workspace</h3>
        <form onsubmit="createWorkspace(event)">
          <label>Workspace Name</label>
          <input type="text" id="workspaceName" required />

          <label>Description</label>
          <textarea id="workspaceDesc" rows="3"></textarea>

          <label>Type</label>
          <select id="workspaceType">
            <option value="Team">Team</option>
            <option value="Private">Private</option>
            <option value="Public">Public</option>
          </select>

          <div style="margin-top: 15px;">
            <button type="submit">üíæ Create Workspace</button>
            <button type="button" onclick="cancelWorkspaceForm()">‚ùå Cancel</button>
          </div>
        </form>
      </div>

      <!-- View Workspaces -->
      <div id="workspaceView" style="display:none;">
        <h3>All Workspaces</h3>
        <table id="workspaceTable">
          <thead>
            <tr>
              <th>Select</th>
              <th>Workspace ID</th>
              <th>Name</th>
              <th>Description</th>
              <th>Type</th>
              <th>Members</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button onclick="hideWorkspaceView()">‚ùå Close</button>
      </div>

      <!-- Delete Workspace Form -->
      <div id="deleteWorkspaceForm" style="display:none;">
        <h3>Delete Workspace</h3>
        <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <p style="color: #c62828; margin: 0;">‚ö†Ô∏è Warning: This action cannot be undone!</p>
        </div>
        <div>
          <label>Select Workspace to Delete</label>
          <select id="deleteWorkspaceSelect" required>
            <option value="">Choose a workspace...</option>
          </select>

          <div style="margin-top: 15px;">
            <button onclick="deleteSelectedWorkspace()" style="background: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">üóë DELETE</button>
            <button onclick="cancelDeleteWorkspace()" style="background: #666; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">‚ùå Cancel</button>
          </div>
        </div>
      </div>
    </section>

    <!-- System Settings -->
    <section id="system-settings" class="section">
      <h2>‚öôÔ∏è System Settings</h2>
      <div class="settings-list">
        <div class="setting-item">
          <span>üîß Update System</span>
          <button>Update</button>
        </div>
        <div class="setting-item">
          <span>üîí Set Permissions</span>
          <button>Manage</button>
        </div>
        <div class="setting-item">
          <span>üö™ Logout</span>
          <button onclick="logout()" style="background: #f44336; color: white;">Logout</button>
        </div>
      </div>
    </section>

    <!-- View Reports -->
    <section id="view-reports" class="section">
      <h2>üìä View Reports</h2>
      <div class="cards">
        <div class="card">
          <h3>üìà Analytics</h3>
          <p>Track user and workspace growth trends.</p>
        </div>
        <div class="card">
          <h3>üìú Logs</h3>
          <p>View system activities and logs for security monitoring.</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Logout Confirmation Modal -->
  <div id="logoutModal" class="modal" style="display:none;">
    <div class="modal-content" style="text-align: center; max-width: 400px;">
      <h3>üö™ Confirm Logout</h3>
      <p style="margin: 20px 0; color: #666;">Are you sure you want to logout?</p>
      <div style="display: flex; gap: 15px; justify-content: center;">
        <button onclick="confirmLogout()" style="background: #f44336;">Yes, Logout</button>
        <button onclick="cancelLogout()" style="background: #666;">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // Initialize user counter for proper ID generation
    let userIdCounter = 1;

    // -------- PROPER AUTHENTICATION GUARD --------
    document.addEventListener('DOMContentLoaded', () => {
      checkAdminAuthentication();
      displayAdminInfo();
      initializeUserCounter();
      refreshUserTable();
      updateUserCount();
      updateWorkspaceCount();
    });

    function checkAdminAuthentication() {
      const isLoggedIn = sessionStorage.getItem("isLoggedIn") === "true";
      const role = sessionStorage.getItem("role");
      const email = sessionStorage.getItem("userEmail");
      const loginTime = sessionStorage.getItem('loginTime');
      
      console.log('üîç Checking authentication...');
      console.log('isLoggedIn:', isLoggedIn);
      console.log('role:', role);
      console.log('email:', email);
      
      // ‚úÖ Only allow admin users
      if (!isLoggedIn || role !== "admin") {
        alert("üö´ Access Denied! Admins only.");
        sessionStorage.clear();
        window.location.href = "Login page.html";
        return;
      }

      // Check session validity (optional: expire after 24 hours)
      if (loginTime) {
        const loginDate = new Date(loginTime);
        const now = new Date();
        const hoursSinceLogin = (now - loginDate) / (1000 * 60 * 60);
        
        if (hoursSinceLogin > 24) {
          alert('‚è∞ Session expired. Please login again.');
          sessionStorage.clear();
          window.location.href = 'Login page.html';
          return;
        }
      }

      console.log('‚úÖ Admin access granted for:', email);
    }

    function displayAdminInfo() {
      const userEmail = sessionStorage.getItem('userEmail') || 'sha123@gmail.com';
      const userName = userEmail.split('@')[0];
      
      document.getElementById('adminEmailDisplay').textContent = userEmail;
      
      // Update welcome message
      const welcomeTitle = document.querySelector('h1');
      if (welcomeTitle && welcomeTitle.textContent.includes('Welcome')) {
        welcomeTitle.textContent = `Welcome Back, Admin ${userName}! üëë`;
      }
    }

    // Initialize user counter based on existing users
    function initializeUserCounter() {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      
      if (users.length === 0) {
        userIdCounter = 1;
      } else {
        // Find the highest user ID number and increment
        let maxId = 0;
        users.forEach(user => {
          if (user.userId && user.userId.startsWith('U')) {
            const idNumber = parseInt(user.userId.substring(1));
            if (!isNaN(idNumber) && idNumber > maxId) {
              maxId = idNumber;
            }
          }
        });
        userIdCounter = maxId + 1;
      }
    }

    // Generate formatted user ID (U001, U002, etc.)
    function generateUserId() {
      const formattedId = `U${String(userIdCounter).padStart(3, '0')}`;
      userIdCounter++;
      return formattedId;
    }

    // -------- NAV --------
    function showSection(sectionId, link) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      const target = document.getElementById(sectionId);
      if (target) target.classList.add('active');

      document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
      if (link) link.classList.add('active');
    }

    // -------- LOGOUT --------
    function logout() {
      document.getElementById('logoutModal').style.display = 'block';
    }

    function confirmLogout() {
      // Clear session data
      sessionStorage.clear();
      
      // Also clear any localStorage auth data for good measure
      localStorage.removeItem('isLoggedIn');
      localStorage.removeItem('role');
      localStorage.removeItem('userEmail');
      
      alert('‚úÖ Admin logged out successfully!');
      window.location.href = 'Landing Page.html';
    }

    function cancelLogout() {
      document.getElementById('logoutModal').style.display = 'none';
    }

    // -------- MANAGE USERS (UPDATED WITH PROPER IDs) --------
    let currentAction = 'add';
    let editingUserId = null;

    function refreshUserTable() {
      // Show loading message briefly
      const tbody = document.querySelector('#userTable tbody');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #888;">üîÑ Refreshing...</td></tr>';
      
      // Simulate refresh with a small delay
      setTimeout(() => {
        loadUserTable();
        alert('‚úÖ User table refreshed!');
      }, 500);
    }

    function loadUserTable() {
      const tbody = document.querySelector('#userTable tbody');
      tbody.innerHTML = '';

      let users = JSON.parse(localStorage.getItem('users') || '[]');

      if (users.length === 0) {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td colspan="6" style="text-align: center; color: #888; font-style: italic;">
            No users registered yet. Users will appear here when they sign up.
          </td>
        `;
        return;
      }

      // Fix users that don't have proper IDs
      let needsUpdate = false;
      users = users.map((user, index) => {
        // Ensure each user has both id and userId
        if (!user.id) {
          user.id = user.id || Date.now() + index;
          needsUpdate = true;
        }
        if (!user.userId) {
          user.userId = generateUserId();
          needsUpdate = true;
        }
        return user;
      });

      // Save updated users if needed
      if (needsUpdate) {
        localStorage.setItem('users', JSON.stringify(users));
      }

      users.forEach((user, index) => {
        const row = tbody.insertRow();
        const isCurrentAdmin = user.role === 'admin' && user.email === sessionStorage.getItem('userEmail');
        const createdDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A';
        
        // Use a unique identifier - prefer id, fallback to index
        const uniqueId = user.id || index;
        
        row.innerHTML = `
          <td><input type="radio" name="selectedUser" value="${uniqueId}" data-email="${user.email}" ${isCurrentAdmin ? 'disabled' : ''}></td>
          <td>${user.userId}</td>
          <td>${user.email}</td>
          <td style="text-transform: capitalize;">${user.role || 'user'}</td>
          <td><span style="color: #4caf50; font-weight: 600;">‚óè</span> Active</td>
          <td>${createdDate}</td>
        `;
      });

      console.log('Users loaded:', users.length);
      console.log('Users data:', users);
    }

    function openUserForm(action) {
      currentAction = action;
      const modal = document.getElementById('userFormModal');
      const formTitle = document.getElementById('formTitle');
      const userEmail = document.getElementById('userEmail');
      const userPassword = document.getElementById('userPassword');
      const userRole = document.getElementById('userRole');

      if (action === 'add') {
        formTitle.textContent = 'Add User';
        userEmail.value = '';
        userPassword.value = '';
        userRole.value = 'user';
        editingUserId = null;
      } else if (action === 'edit') {
        formTitle.textContent = 'Edit User';
        const selected = document.querySelector("input[name='selectedUser']:checked");
        if (!selected) {
          alert('‚ùå Please select a user to edit.');
          return;
        }
        
        const userId = parseInt(selected.value);
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const user = users.find(u => u.id === userId);
        
        if (!user) {
          alert('‚ùå User not found.');
          return;
        }
        
        userEmail.value = user.email;
        userPassword.value = user.password;
        userRole.value = user.role || 'user';
        editingUserId = userId;
      }
      
      modal.style.display = 'block';
    }

    function closeUserForm() {
      document.getElementById('userFormModal').style.display = 'none';
    }

    function saveUser(event) {
      event.preventDefault();
      const userEmail = document.getElementById('userEmail').value.trim();
      const userPassword = document.getElementById('userPassword').value;
      const userRole = document.getElementById('userRole').value;

      if (!userEmail || !userPassword) {
        alert('‚ùå Email and Password are required.');
        return;
      }

      let users = JSON.parse(localStorage.getItem('users') || '[]');

      if (currentAction === 'add') {
        // Check if email already exists
        if (users.some(u => u.email.toLowerCase() === userEmail.toLowerCase())) {
          alert('‚ùå Email already exists!');
          return;
        }

        const newUser = {
          id: Date.now(),
          userId: generateUserId(), // Generate formatted user ID
          email: userEmail,
          password: userPassword,
          role: userRole,
          createdAt: new Date().toISOString()
        };

        users.push(newUser);
        alert('‚úÖ User added successfully!');
        
      } else if (currentAction === 'edit' && editingUserId) {
        const userIndex = users.findIndex(u => u.id === editingUserId);
        if (userIndex > -1) {
          // Check if email is taken by another user
          const emailTaken = users.some(u => u.id !== editingUserId && u.email.toLowerCase() === userEmail.toLowerCase());
          if (emailTaken) {
            alert('‚ùå Email is already taken by another user!');
            return;
          }
          
          users[userIndex].email = userEmail;
          users[userIndex].password = userPassword;
          users[userIndex].role = userRole;
          alert('‚úÖ User updated successfully!');
        }
      }

      localStorage.setItem('users', JSON.stringify(users));
      loadUserTable();
      closeUserForm();
      updateUserCount();
    }

    function removeUser() {
      const selected = document.querySelector("input[name='selectedUser']:checked");
      if (!selected) {
        alert('‚ùå Please select a user to remove.');
        return;
      }
      
      // Get the selected value and email
      const selectedValue = selected.value;
      const selectedEmail = selected.getAttribute('data-email');
      let users = JSON.parse(localStorage.getItem('users') || '[]');
      
      console.log('Attempting to remove user:', selectedValue, selectedEmail);
      console.log('Available users:', users);
      
      // Find the user by ID first, then by email as fallback
      let userToRemove = users.find(u => u.id && u.id.toString() === selectedValue);
      if (!userToRemove) {
        userToRemove = users.find(u => u.email === selectedEmail);
      }
      
      // If still not found, try finding by array index
      if (!userToRemove) {
        const index = parseInt(selectedValue);
        if (!isNaN(index) && users[index]) {
          userToRemove = users[index];
        }
      }
      
      if (!userToRemove) {
        alert('‚ùå User not found. Please refresh the page and try again.');
        console.error('User not found with value:', selectedValue, 'email:', selectedEmail);
        return;
      }
      
      // Check if trying to remove current admin
      const currentAdminEmail = sessionStorage.getItem('userEmail');
      if (userToRemove.email === currentAdminEmail && userToRemove.role === 'admin') {
        alert('‚ùå You cannot remove yourself while logged in as admin.');
        return;
      }
      
      if (confirm(`‚ö†Ô∏è Are you sure you want to remove user "${userToRemove.email}"?\n\nUser ID: ${userToRemove.userId || 'N/A'}\nRole: ${userToRemove.role || 'user'}\n\nThis action cannot be undone.`)) {
        // Remove the user using email as the most reliable identifier
        const originalLength = users.length;
        users = users.filter(u => u.email !== userToRemove.email);
        
        // Verify user was actually removed
        if (users.length === originalLength) {
          alert('‚ùå Failed to remove user. Please try again.');
          return;
        }
        
        // Save updated users array
        localStorage.setItem('users', JSON.stringify(users));
        
        // Refresh the table and update count
        loadUserTable();
        updateUserCount();
        
        alert(`‚úÖ User "${userToRemove.email}" (${userToRemove.userId || 'N/A'}) has been removed successfully!`);
        
        console.log('User removed successfully:', userToRemove.email);
        console.log('Remaining users:', users.length);
      }
    }

    function updateUserCount() {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      document.getElementById('userCount').textContent = `${users.length} Registered Users`;
    }

    // -------- WORKSPACE MANAGEMENT --------
    let workspaces = JSON.parse(localStorage.getItem('workspaces') || '[]');
    let workspaceCounter = workspaces.length + 1;

    function openWorkspaceForm() {
      hideAllWorkspaceForms();
      document.getElementById('createWorkspaceForm').style.display = 'block';
      document.getElementById('workspaceName').value = '';
      document.getElementById('workspaceDesc').value = '';
      document.getElementById('workspaceType').value = 'Team';
    }

    function createWorkspace(event) {
      event.preventDefault();
      const name = document.getElementById('workspaceName').value.trim();
      const desc = document.getElementById('workspaceDesc').value.trim();
      const type = document.getElementById('workspaceType').value;

      if (!name) {
        alert('‚ùå Workspace name is required.');
        return;
      }

      const newWorkspace = {
        id: `W${String(workspaceCounter).padStart(3, '0')}`,
        name,
        description: desc || 'No description',
        type,
        members: 0
      };

      workspaces.push(newWorkspace);
      workspaceCounter++;

      localStorage.setItem('workspaces', JSON.stringify(workspaces));

      alert(`‚úÖ Workspace "${name}" created successfully!`);
      cancelWorkspaceForm();
      updateWorkspaceCount();
    }

    function viewWorkspaces() {
      hideAllWorkspaceForms();
      document.getElementById('workspaceView').style.display = 'block';

      const tbody = document.querySelector('#workspaceTable tbody');
      tbody.innerHTML = '';

      if (workspaces.length === 0) {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td colspan="6" style="text-align: center; color: #888; font-style: italic;">
            No workspaces created yet. Create your first workspace!
          </td>
        `;
        return;
      }

      workspaces.forEach(ws => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td><input type="radio" name="selectedWorkspace" value="${ws.id}"></td>
          <td>${ws.id}</td>
          <td>${ws.name}</td>
          <td>${ws.description}</td>
          <td>${ws.type}</td>
          <td>${ws.members}</td>
        `;
      });
    }

    function hideWorkspaceView() {
      document.getElementById('workspaceView').style.display = 'none';
    }

    function openDeleteWorkspace() {
      hideAllWorkspaceForms();
      document.getElementById('deleteWorkspaceForm').style.display = 'block';

      const select = document.getElementById('deleteWorkspaceSelect');
      select.innerHTML = '<option value="">Choose a workspace...</option>';
      
      if (workspaces.length === 0) {
        select.innerHTML = '<option value="">No workspaces to delete</option>';
        return;
      }
      
      workspaces.forEach(ws => {
        select.innerHTML += `<option value="${ws.id}">${ws.name}</option>`;
      });
    }

    function deleteSelectedWorkspace() {
      const workspaceId = document.getElementById('deleteWorkspaceSelect').value;

      if (!workspaceId) {
        alert('‚ùå Please choose a workspace to delete.');
        return;
      }

      const workspaceToDelete = workspaces.find(ws => ws.id === workspaceId);
      if (!workspaceToDelete) {
        alert('‚ùå Workspace not found.');
        return;
      }

      if (confirm(`‚ö†Ô∏è Are you sure you want to delete "${workspaceToDelete.name}"? This action cannot be undone.`)) {
        workspaces = workspaces.filter(ws => ws.id !== workspaceId);
        localStorage.setItem('workspaces', JSON.stringify(workspaces));
        
        alert(`‚úÖ Workspace "${workspaceToDelete.name}" has been deleted.`);
        cancelDeleteWorkspace();
        updateWorkspaceCount();
      }
    }

    function cancelWorkspaceForm() {
      hideAllWorkspaceForms();
    }

    function cancelDeleteWorkspace() {
      hideAllWorkspaceForms();
    }

    function hideAllWorkspaceForms() {
      document.getElementById('createWorkspaceForm').style.display = 'none';
      document.getElementById('workspaceView').style.display = 'none';
      document.getElementById('deleteWorkspaceForm').style.display = 'none';
    }

    function updateWorkspaceCount() {
      document.getElementById('workspaceCount').textContent = `${workspaces.length} Workspaces`;
    }

    // -------- MODAL OUTSIDE CLICK CLOSE --------
    window.onclick = function (event) {
      const userModal = document.getElementById('userFormModal');
      const logoutModal = document.getElementById('logoutModal');

      if (event.target === userModal) closeUserForm();
      if (event.target === logoutModal) cancelLogout();
    };

    // -------- PREVENT BACK BUTTON ACCESS AFTER LOGOUT --------
    window.addEventListener('pageshow', function(event) {
      if (event.persisted) {
        // Page was loaded from cache, recheck authentication
        checkAdminAuthentication();
      }
    });

    // Prevent unauthorized access through browser navigation
    window.addEventListener('beforeunload', function() {
      // Session data will persist for legitimate navigation
      // but will be cleared on login page
    });
  </script>
</body>
</html>